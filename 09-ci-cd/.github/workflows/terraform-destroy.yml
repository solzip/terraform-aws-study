# ==========================================
# terraform-destroy.yml - Terraform Destroy ì›Œí¬í”Œë¡œìš°
# ==========================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ì˜ ì—­í• :
#   ë°°í¬ëœ ì¸í”„ë¼ë¥¼ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤.
#   ì‹¤ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•´ ì´ì¤‘ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
#
# âš ï¸ ì£¼ì˜: DestroyëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!
#   ëª¨ë“  ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œë˜ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì‹¤í–‰í•˜ì„¸ìš”.
#
# ì•ˆì „ì¥ì¹˜:
#   1. ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
#   2. í™•ì¸ ë¬¸ìì—´ ì…ë ¥ í•„ìš” ("destroy" ì…ë ¥)
#   3. Planìœ¼ë¡œ ì‚­ì œ ëŒ€ìƒ í™•ì¸ í›„ ì‹¤í–‰

name: "Terraform Destroy"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "ì‚­ì œí•  í™˜ê²½ ì„ íƒ"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev

      # ì´ì¤‘ í™•ì¸: "destroy"ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì•¼ ì‹¤í–‰
      confirm_destroy:
        description: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? 'destroy'ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”"
        required: true
        type: string

jobs:
  # ==========================================
  # Job 1: Destroy Plan (ì‚­ì œ ëŒ€ìƒ í™•ì¸)
  # ==========================================
  destroy-plan:
    name: "Destroy Plan (${{ github.event.inputs.environment }})"
    runs-on: ubuntu-latest
    # "destroy"ë¥¼ ì •í™•íˆ ì…ë ¥í–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.inputs.confirm_destroy == 'destroy'

    defaults:
      run:
        working-directory: 09-ci-cd

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ap-northeast-2

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Init
        run: terraform init -backend=false

      # Destroy Plan: ì–´ë–¤ ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œë ì§€ ë¯¸ë¦¬ í™•ì¸
      - name: Terraform Destroy Plan
        run: |
          echo "âš ï¸ The following resources will be DESTROYED:"
          terraform plan \
            -destroy \
            -var="environment=${{ github.event.inputs.environment }}" \
            -no-color \
            -input=false

  # ==========================================
  # Job 2: Destroy (ì‹¤ì œ ì‚­ì œ)
  # ==========================================
  destroy:
    name: "Destroy (${{ github.event.inputs.environment }})"
    runs-on: ubuntu-latest
    needs: destroy-plan

    # prod í™˜ê²½ì€ íŠ¹ë³„íˆ ë³´í˜¸
    environment: ${{ github.event.inputs.environment }}

    defaults:
      run:
        working-directory: 09-ci-cd

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ap-northeast-2

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Destroy
        run: |
          echo "ğŸ—‘ï¸ Destroying ${{ github.event.inputs.environment }} environment..."
          terraform destroy \
            -var="environment=${{ github.event.inputs.environment }}" \
            -auto-approve \
            -input=false
          echo "âœ… Destroy complete."
