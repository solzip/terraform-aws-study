# ==========================================
# terraform-plan.yml - Terraform Plan 워크플로우
# ==========================================
#
# 이 워크플로우의 역할:
#   PR이 생성되면 terraform plan을 실행하고
#   그 결과를 PR 코멘트에 표시합니다.
#
# 왜 PR에서 Plan을 실행하는가?
#   - 코드 변경이 어떤 인프라 변경을 초래하는지 미리 확인
#   - 리뷰어가 Plan 결과를 보고 승인 여부 결정
#   - 실수로 인한 위험한 변경(삭제 등)을 사전에 발견
#
# 보안 주의:
#   - Plan은 AWS 리소스를 변경하지 않습니다 (읽기 전용)
#   - 하지만 AWS 자격증명이 필요합니다 (리소스 조회를 위해)
#   - GitHub Secrets에 자격증명을 안전하게 저장하세요

name: "Terraform Plan"

on:
  pull_request:
    branches: [main]
    paths:
      - "09-ci-cd/**"

# ==========================================
# 동시 실행 제어
# ==========================================
# 같은 PR에서 여러 Plan이 동시에 실행되지 않도록 합니다.
# 새 Push가 오면 이전 실행을 취소합니다.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ==========================================
# 권한 설정
# ==========================================
# PR에 코멘트를 달기 위해 write 권한이 필요합니다.
permissions:
  contents: read        # 코드 읽기
  pull-requests: write  # PR 코멘트 작성

jobs:
  plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: 09-ci-cd

    # ==========================================
    # 환경 변수
    # ==========================================
    # AWS 자격증명은 GitHub Secrets에서 가져옵니다.
    # Settings → Secrets → Actions에서 설정하세요.
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ap-northeast-2

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false
        continue-on-error: true

      # ==========================================
      # Plan 결과를 PR 코멘트에 표시
      # ==========================================
      # Plan 결과가 길 수 있으므로 접히는 섹션으로 표시합니다.
      # 리뷰어가 변경 사항을 한눈에 확인할 수 있습니다.
      - name: Post Plan Results to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const plan = process.env.PLAN || 'No plan output';
            // Plan 결과가 65000자를 초과하면 잘라냅니다
            const truncatedPlan = plan.length > 65000
              ? plan.substring(0, 65000) + '\n\n... (truncated)'
              : plan;

            const output = `### Terraform Plan Result

            **Status:** ${{ steps.plan.outcome == 'success' && '✅ Success' || '❌ Failed' }}

            <details>
            <summary>Plan Details (click to expand)</summary>

            \`\`\`
            ${truncatedPlan}
            \`\`\`

            </details>

            *Plan by: @${{ github.actor }} | Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      # Plan 실패 시 워크플로우도 실패
      - name: Check Plan Result
        if: steps.plan.outcome == 'failure'
        run: exit 1
