# 05-remote-state - ì›ê²© State ê´€ë¦¬

> ğŸŸ¡ **ë‚œì´ë„**: ì¤‘ê¸‰ | **í•™ìŠµ ì‹œê°„**: 3ì‹œê°„

[â† ë©”ì¸ READMEë¡œ ëŒì•„ê°€ê¸°](../../) | [â† ì´ì „: 04-modules-basic](../../tree/04-modules-basic)

## ğŸ“š í•™ìŠµ ëª©í‘œ

- âœ… Terraform State íŒŒì¼ì˜ ì—­í• ê³¼ ì¤‘ìš”ì„± ì´í•´
- âœ… S3 Backendë¡œ Stateë¥¼ ì›ê²© ì €ì¥ì†Œì— ê´€ë¦¬
- âœ… DynamoDBë¥¼ ì´ìš©í•œ State Locking (ë™ì‹œ ì‘ì—… ë°©ì§€)
- âœ… State íŒŒì¼ ì•”í˜¸í™” (ë³´ì•ˆ ê°•í™”)
- âœ… íŒ€ í˜‘ì—…ì„ ìœ„í•œ State ê³µìœ  ë°©ë²•
- âœ… ë¡œì»¬ State â†’ ì›ê²© State ë§ˆì´ê·¸ë ˆì´ì…˜

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AWS Cloud                            â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  S3 Bucket           â”‚  â”‚  DynamoDB Table           â”‚ â”‚
â”‚  â”‚  (State ì €ì¥ì†Œ)       â”‚  â”‚  (State ì ê¸ˆ)             â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚  terraform.tfstate   â”‚  â”‚  LockID (ì ê¸ˆ í‚¤)         â”‚ â”‚
â”‚  â”‚  - ë²„ì „ ê´€ë¦¬ í™œì„±í™”  â”‚  â”‚  - terraform apply ì¤‘     â”‚ â”‚
â”‚  â”‚  - AES-256 ì•”í˜¸í™”    â”‚  â”‚    ë‹¤ë¥¸ ì‚¬ëŒ ë³€ê²½ ì°¨ë‹¨    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                         â”‚                  â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                      â”‚                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚  Terraform CLI  â”‚                         â”‚
â”‚              â”‚  (ë¡œì»¬ ì‹¤í–‰)    â”‚                         â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                      â”‚                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚  AWS ë¦¬ì†ŒìŠ¤     â”‚                         â”‚
â”‚              â”‚  (VPC, EC2 ë“±) â”‚                          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
05-remote-state/
â”œâ”€â”€ README.md                  # í˜„ì¬ ë¬¸ì„œ
â”œâ”€â”€ backend-setup/             # 1ë‹¨ê³„: Backend ì¸í”„ë¼ ìƒì„±
â”‚   â”œâ”€â”€ main.tf               # S3 ë²„í‚· + DynamoDB í…Œì´ë¸”
â”‚   â”œâ”€â”€ outputs.tf            # ë²„í‚·/í…Œì´ë¸” ì´ë¦„ ì¶œë ¥
â”‚   â””â”€â”€ README.md             # Backend ì„¤ì • ê°€ì´ë“œ
â”œâ”€â”€ main.tf                   # 2ë‹¨ê³„: ì‹¤ì œ ì¸í”„ë¼ (VPC, EC2)
â”œâ”€â”€ variables.tf              # ë³€ìˆ˜ ì •ì˜
â”œâ”€â”€ outputs.tf                # ì¶œë ¥ ê°’
â”œâ”€â”€ versions.tf               # Terraform/Provider ë²„ì „
â”œâ”€â”€ backend.tf                # S3 Backend ì„¤ì •
â”œâ”€â”€ backend.hcl               # Backend ì„¤ì • íŒŒì¼ (ë³€ìˆ˜ ë¶„ë¦¬)
â””â”€â”€ docs/
    â””â”€â”€ state-migration.md    # State ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ
```

## ğŸš€ ì‹¤ìŠµ ê°€ì´ë“œ

### 1ë‹¨ê³„: Backend ì¸í”„ë¼ ìƒì„± (S3 + DynamoDB)

```bash
cd backend-setup
terraform init
terraform apply
# â†’ S3 ë²„í‚·ê³¼ DynamoDB í…Œì´ë¸”ì´ ìƒì„±ë©ë‹ˆë‹¤
```

### 2ë‹¨ê³„: ì›ê²© Backendë¡œ ì´ˆê¸°í™”

```bash
cd ..
terraform init -backend-config=backend.hcl
# â†’ Stateê°€ S3ì— ì €ì¥ë˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤
```

### 3ë‹¨ê³„: ì¸í”„ë¼ ë°°í¬

```bash
terraform plan
terraform apply
# â†’ Stateê°€ ë¡œì»¬ì´ ì•„ë‹Œ S3ì— ì €ì¥ë©ë‹ˆë‹¤
```

### 4ë‹¨ê³„: State ì ê¸ˆ í™•ì¸

```bash
# í„°ë¯¸ë„ Aì—ì„œ apply ì‹¤í–‰ ì¤‘
terraform apply

# í„°ë¯¸ë„ Bì—ì„œ ë™ì‹œì— apply ì‹œë„í•˜ë©´
# Error: Error acquiring the state lock
# â†’ DynamoDBê°€ ë™ì‹œ ì ‘ê·¼ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤!
```

### 5ë‹¨ê³„: ë¦¬ì†ŒìŠ¤ ì •ë¦¬

```bash
# ì¸í”„ë¼ ë¨¼ì € ì‚­ì œ
terraform destroy

# Backend ì¸í”„ë¼ ì‚­ì œ (ì„ íƒì‚¬í•­)
cd backend-setup
terraform destroy
```

## ğŸ’¡ í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸

### 1. ì™œ ì›ê²© Stateê°€ í•„ìš”í•œê°€?

| êµ¬ë¶„ | ë¡œì»¬ State | ì›ê²© State (S3) |
|------|-----------|----------------|
| ì €ì¥ ìœ„ì¹˜ | ë‚´ PCì˜ terraform.tfstate | S3 ë²„í‚· |
| íŒ€ í˜‘ì—… | âŒ ê³µìœ  ë¶ˆê°€ | âœ… íŒ€ì› ëª¨ë‘ ì ‘ê·¼ |
| ë™ì‹œ ì‘ì—… | âŒ ì¶©ëŒ ìœ„í—˜ | âœ… DynamoDB ì ê¸ˆ |
| ë°±ì—… | âŒ ìˆ˜ë™ ë°±ì—… | âœ… S3 ë²„ì „ ê´€ë¦¬ |
| ë³´ì•ˆ | âŒ ë¡œì»¬ íŒŒì¼ | âœ… ì•”í˜¸í™” + IAM |

### 2. Backend ì„¤ì • ë°©ë²•

```hcl
# backend.tf
terraform {
  backend "s3" {
    bucket         = "my-terraform-state"     # State ì €ì¥ ë²„í‚·
    key            = "terraform.tfstate"       # State íŒŒì¼ ê²½ë¡œ
    region         = "ap-northeast-2"          # ë²„í‚· ë¦¬ì „
    encrypt        = true                      # ì•”í˜¸í™” í™œì„±í™”
    dynamodb_table = "terraform-lock"          # ì ê¸ˆ í…Œì´ë¸”
  }
}
```

### 3. Backend ì„¤ì • íŒŒì¼ ë¶„ë¦¬ (backend.hcl)

```hcl
# backend.hcl - í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ ì„¤ì • íŒŒì¼ ì‚¬ìš© ê°€ëŠ¥
bucket         = "my-terraform-state"
key            = "05-remote-state/terraform.tfstate"
region         = "ap-northeast-2"
encrypt        = true
dynamodb_table = "terraform-lock"
```

```bash
# ì‚¬ìš©ë²•
terraform init -backend-config=backend.hcl
```

## ğŸ”§ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. S3 ë²„í‚· ë³´ì•ˆ
- âœ… ë²„ì „ ê´€ë¦¬ í™œì„±í™” (State ë³µêµ¬ìš©)
- âœ… ì„œë²„ ì¸¡ ì•”í˜¸í™” (AES-256)
- âœ… í¼ë¸”ë¦­ ì ‘ê·¼ ì°¨ë‹¨
- âœ… IAM ì •ì±…ìœ¼ë¡œ ì ‘ê·¼ ì œí•œ

### 2. DynamoDB í…Œì´ë¸”
- âœ… íŒŒí‹°ì…˜ í‚¤: `LockID` (ë¬¸ìì—´)
- âœ… ê³¼ê¸ˆ: ì˜¨ë””ë§¨ë“œ (ì†ŒëŸ‰ ì‚¬ìš© ì‹œ ì €ë ´)

### 3. State ê´€ë¦¬ ê·œì¹™
- âš ï¸ State íŒŒì¼ì„ **ì ˆëŒ€** ìˆ˜ë™ í¸ì§‘í•˜ì§€ ë§ˆì„¸ìš”
- âš ï¸ `terraform state` ëª…ë ¹ìœ¼ë¡œë§Œ ì¡°ì‘
- âš ï¸ Backend ë³€ê²½ ì‹œ ë°˜ë“œì‹œ `terraform init -migrate-state`

## âœ… í•™ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] State íŒŒì¼ì˜ ì—­í•  ì´í•´
- [ ] S3 Backend ì„¤ì • ì™„ë£Œ
- [ ] DynamoDB State Locking ë™ì‘ í™•ì¸
- [ ] backend.hclë¡œ ì„¤ì • ë¶„ë¦¬
- [ ] íŒ€ í˜‘ì—… ì‹œë‚˜ë¦¬ì˜¤ ì´í•´
- [ ] State ë§ˆì´ê·¸ë ˆì´ì…˜ ê°œë… ì´í•´
- [ ] ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ

## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

ì›ê²© State ê´€ë¦¬ë¥¼ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤! ğŸ‰

```bash
terraform destroy
cd backend-setup && terraform destroy
git checkout 06-security-basic
```

06-security-basicì—ì„œëŠ”:
- IAM Role ë° Policy ìƒì„±
- Secrets Manager ê¸°ì´ˆ
- KMS ì•”í˜¸í™” ê¸°ì´ˆ

[â† ì´ì „: 04-modules-basic](../../tree/04-modules-basic) | [ë‹¤ìŒ: 06-security-basic â†’](../../tree/06-security-basic)

---

**ì‘ì„±ì¼**: 2025-02-02
**ë‚œì´ë„**: ğŸŸ¡ ì¤‘ê¸‰
**í•™ìŠµ ì‹œê°„**: 3ì‹œê°„
