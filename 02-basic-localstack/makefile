# Makefile for LocalStack Terraform Project
# ìì£¼ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ê°„í¸í•˜ê²Œ ì‹¤í–‰

.PHONY: help start stop restart logs health init validate plan apply destroy clean test all

# ê¸°ë³¸ íƒ€ê²Ÿ - help ì¶œë ¥
.DEFAULT_GOAL := help

# ë„ì›€ë§
help: ## ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ í‘œì‹œ
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "  LocalStack Terraform í”„ë¡œì íŠ¸ ëª…ë ¹ì–´"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ==========================================
# LocalStack ê´€ë¦¬
# ==========================================

start: ## LocalStack ì‹œì‘
	@echo "ğŸš€ Starting LocalStack..."
	docker-compose up -d
	@echo "â³ Waiting for LocalStack to be ready..."
	@sleep 5
	@$(MAKE) health

stop: ## LocalStack ì¤‘ì§€
	@echo "ğŸ›‘ Stopping LocalStack..."
	docker-compose down

restart: ## LocalStack ì¬ì‹œì‘
	@echo "ğŸ”„ Restarting LocalStack..."
	@$(MAKE) stop
	@$(MAKE) start

logs: ## LocalStack ë¡œê·¸ í™•ì¸ (ì‹¤ì‹œê°„)
	docker-compose logs -f

health: ## LocalStack ìƒíƒœ í™•ì¸
	@echo "ğŸ¥ Checking LocalStack health..."
	@curl -s http://localhost:4566/_localstack/health | jq . || \
		echo "âŒ LocalStack is not running or jq is not installed"

ps: ## ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
	docker-compose ps

# ==========================================
# Terraform ì‘ì—…
# ==========================================

init: start ## Terraform ì´ˆê¸°í™” (LocalStack ìë™ ì‹œì‘)
	@echo "ğŸ“¦ Initializing Terraform..."
	terraform init

validate: ## Terraform êµ¬ì„± ê²€ì¦
	@echo "âœ… Validating Terraform configuration..."
	terraform validate

fmt: ## Terraform ì½”ë“œ í¬ë§·íŒ…
	@echo "ğŸ¨ Formatting Terraform code..."
	terraform fmt -recursive

plan: init ## Terraform ì‹¤í–‰ ê³„íš í™•ì¸
	@echo "ğŸ“‹ Planning Terraform changes..."
	terraform plan

apply: init ## Terraform ì ìš© (ìë™ ìŠ¹ì¸)
	@echo "ğŸš€ Applying Terraform configuration..."
	terraform apply -auto-approve

destroy: ## Terraform ë¦¬ì†ŒìŠ¤ ì‚­ì œ
	@echo "ğŸ’¥ Destroying Terraform resources..."
	terraform destroy -auto-approve

# ==========================================
# ìœ í‹¸ë¦¬í‹°
# ==========================================

clean: destroy stop ## ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (Terraform + LocalStack)
	@echo "ğŸ§¹ Cleaning up..."
	rm -rf .terraform
	rm -rf .terraform.lock.hcl
	rm -f terraform.tfstate*
	rm -rf localstack/data/*
	@echo "âœ¨ Cleanup complete!"

reset: clean ## ì™„ì „ ì´ˆê¸°í™” (clean + Docker ì´ë¯¸ì§€ ì‚­ì œ)
	@echo "ğŸ”„ Resetting everything..."
	docker-compose down -v --rmi local
	@echo "âœ¨ Reset complete!"

test: all ## ì „ì²´ í…ŒìŠ¤íŠ¸ (ì‹œì‘ â†’ ì ìš© â†’ í™•ì¸ â†’ ì‚­ì œ)
	@echo "ğŸ§ª Running full test..."
	@$(MAKE) clean
	@$(MAKE) apply
	@echo "â³ Waiting 10 seconds..."
	@sleep 10
	@$(MAKE) check
	@$(MAKE) destroy
	@echo "âœ… Test complete!"

all: start init apply ## ì „ì²´ ì‘ì—… ì‹¤í–‰ (ì‹œì‘ â†’ ì´ˆê¸°í™” â†’ ì ìš©)
	@echo "âœ… All tasks completed!"

# ==========================================
# AWS CLI (LocalStack)
# ==========================================

aws-config: ## AWS CLI ì„¤ì • (LocalStackìš©)
	@echo "âš™ï¸  Configuring AWS CLI for LocalStack..."
	@echo "[profile localstack]" > ~/.aws/config
	@echo "region = ap-northeast-2" >> ~/.aws/config
	@echo "output = json" >> ~/.aws/config
	@echo "[localstack]" > ~/.aws/credentials
	@echo "aws_access_key_id = test" >> ~/.aws/credentials
	@echo "aws_secret_access_key = test" >> ~/.aws/credentials
	@echo "âœ… AWS CLI configured for LocalStack"

list-vpcs: ## VPC ëª©ë¡ í™•ì¸
	@aws --endpoint-url=http://localhost:4566 ec2 describe-vpcs --query 'Vpcs[*].[VpcId,CidrBlock,Tags[?Key==`Name`].Value|[0]]' --output table

list-instances: ## EC2 ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡ í™•ì¸
	@aws --endpoint-url=http://localhost:4566 ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,State.Name,InstanceType]' --output table

list-s3: ## S3 ë²„í‚· ëª©ë¡ í™•ì¸
	@aws --endpoint-url=http://localhost:4566 s3 ls

# ==========================================
# í™•ì¸ ë° ë””ë²„ê¹…
# ==========================================

check: ## ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ í™•ì¸
	@echo "ğŸ” Checking created resources..."
	@echo "\n=== Terraform State ==="
	@terraform state list || echo "No resources in state"
	@echo "\n=== VPCs ==="
	@$(MAKE) list-vpcs || echo "Failed to list VPCs"
	@echo "\n=== Instances ==="
	@$(MAKE) list-instances || echo "Failed to list instances"

output: ## Terraform ì¶œë ¥ í™•ì¸
	@terraform output

shell: ## LocalStack ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†
	docker-compose exec localstack /bin/bash

# ==========================================
# ê°œë°œ í¸ì˜
# ==========================================

watch-logs: ## ë¡œê·¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (ì»¬ëŸ¬)
	docker-compose logs -f --tail=100 | grep --color=auto -E 'ERROR|WARNING|INFO|$$'

install-deps: ## í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ í™•ì¸
	@echo "ğŸ”§ Checking dependencies..."
	@command -v docker >/dev/null 2>&1 || echo "âŒ Docker not found"
	@command -v docker-compose >/dev/null 2>&1 || echo "âŒ Docker Compose not found"
	@command -v terraform >/dev/null 2>&1 || echo "âŒ Terraform not found"
	@command -v aws >/dev/null 2>&1 || echo "âŒ AWS CLI not found"
	@command -v jq >/dev/null 2>&1 || echo "âŒ jq not found (optional)"
	@echo "âœ… Dependency check complete"

# ==========================================
# ì‚¬ìš© ì˜ˆì‹œ
# ==========================================
#
# ê¸°ë³¸ ì›Œí¬í”Œë¡œìš°:
#   1. make start      # LocalStack ì‹œì‘
#   2. make apply      # ì¸í”„ë¼ ë°°í¬
#   3. make check      # ë¦¬ì†ŒìŠ¤ í™•ì¸
#   4. make destroy    # ë¦¬ì†ŒìŠ¤ ì‚­ì œ
#   5. make stop       # LocalStack ì¤‘ì§€
#
# ë¹ ë¥¸ í…ŒìŠ¤íŠ¸:
#   make test          # ì „ì²´ ìë™í™” í…ŒìŠ¤íŠ¸
#
# ì „ì²´ ì´ˆê¸°í™”:
#   make clean         # ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì •ë¦¬
#   make reset         # ì™„ì „ ì´ˆê¸°í™”